<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Map</title>
  <style>
    * {
      color: red;
    }
    #canvas-container{
      position:relative;
      border:1px solid black;
      width:500px;
      height:300px;
    }
    .subcanvs{
      position:absolute;
      width:100%;
      height:100%;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <h1 id="name">No picture uploaded</h1>
  <div id="canvas-container">
    <canvas id="map" class="subcanvs"></canvas>
    <canvas id="overlay" class="subcanvs"></canvas>
  </div>
  <canvas id="canvas"></canvas>
  <div id="admin-container" class="hidden">
    <input type="file" name='image-upload' id='image-upload' accept="image/*" />
  </div>
  <img id="map-img" class='hidden' />

<script>
// https://stackoverflow.com/a/5448595/9398629
function findGetParameter(parameterName) {
  var result = null,
    tmp = [];
  location.search
    .substr(1)
    .split("&")
    .forEach(function (item) {
      tmp = item.split("=");
      if (tmp[0] === parameterName) {
        result = decodeURIComponent(tmp[1]);
      }
    });
  return result;
}

drawBackground = () => {
  console.log('I was called!')
  console.log(document.getElementById('map-img'));
  console.log(mapCtx);
  mapCtx.drawImage(document.getElementById('map-img'), 0, 0, mapCanvas.width, mapCanvas.height);
}

drawOverlay = () => {
  console.log('overlay!')
}

function pausecomp(millis)
{
    var date = new Date();
    var curDate = null;
    do { curDate = new Date(); }
    while(curDate-date < millis);
}

// https://stackoverflow.com/a/39515846/9398629
document.getElementById('image-upload').addEventListener('change', evt => {
var file = evt.target.files[0]; // FileList object

  var reader = new FileReader();

  reader.onload = () => {
    pausecomp(2000)
    // Store the image
    document.getElementById('map-img').src = reader.result;
    // Blit the image to the screen
    // mapCtx.drawImage(document.getElementById('map-img'), 0, 0, mapCanvas.width, mapCanvas.height);
    drawBackground();
  }
  reader.readAsDataURL(file);
  console.log(file);
}, false);


let socketConnected = false;
const isAdmin = !!findGetParameter('admin');
if (isAdmin) {
  document.getElementById("admin-container").classList.remove('hidden');
}

const socket = new WebSocket("ws://localhost:8999");
socket.onopen = function (event) {
  socket.send('a client connected');
  socketConnected = true;
};

var mapCanvas = document.getElementById("map");
var mapCtx = mapCanvas.getContext("2d");
var overlayCanvas = document.getElementById("overlay");
var overlayCtx = overlayCanvas.getContext("2d");

mapCtx.font = "30px Arial";
if (isAdmin) {
  mapCtx.fillText("Upload an image", 10, 50);
} else {
  mapCtx.fillText("Waiting for Admin...", 10, 50);
}

</script>
</body>
</html>
