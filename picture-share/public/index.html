<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Map</title>
  <script src="./dom-to-image.min.js"></script>
  <style>
    * {
      color: red;
    }
    #canvas-container{
      position:relative;
      border:1px solid black;
      width:800px;
      height:600px;
    }
    .subcanvs{
      position:absolute;
      width:100%;
      height:100%;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <h1 id="name">No picture uploaded</h1>
  <div id="canvas-container">
    <canvas id="map" class="subcanvs"></canvas>
    <canvas id="overlay" class="subcanvs"></canvas>
  </div>
  <div id="admin-container" class="hidden">
    <input type="file" name='image-upload' id='image-upload' accept="image/*" />
  </div>
  <img id="map-img" class='hidden' />

<script>
let socketConnected = false;
const isAdmin = !!findGetParameter('admin');
if (isAdmin) {
  document.getElementById("admin-container").classList.remove('hidden');
}

const socket = new WebSocket("ws://localhost:8999");
socket.onopen = function (event) {
  socket.send('a client connected');
  socketConnected = true;
};

var mapBitmap = null;
var mapCanvas = document.getElementById("map");
var mapCtx = mapCanvas.getContext("2d");
var overlayCanvas = document.getElementById("overlay");
var overlayCtx = overlayCanvas.getContext("2d");

mapCtx.font = "30px Arial";
if (isAdmin) {
  mapCtx.fillText("Upload an image", 10, 50);
} else {
  mapCtx.fillText("Waiting for Admin...", 10, 50);
}

// https://stackoverflow.com/a/5448595/9398629
function findGetParameter(parameterName) {
  var result = null,
    tmp = [];
  location.search
    .substr(1)
    .split("&")
    .forEach(function (item) {
      tmp = item.split("=");
      if (tmp[0] === parameterName) {
        result = decodeURIComponent(tmp[1]);
      }
    });
  return result;
}

// el is an ImageBitmap
drawBackground = el => {
  mapCtx.drawImage(el, 0, 0, mapCanvas.width, mapCanvas.height);
}

drawOverlay = () => {
  console.log('overlay!')
}

function pausecomp(millis)
{
    var date = new Date();
    var curDate = null;
    do { curDate = new Date(); }
    while(curDate-date < millis);
}

// https://stackoverflow.com/a/39515846/9398629
document.getElementById('image-upload').addEventListener('change', evt => {
  var file = evt.target.files[0]; // FileList object
  var reader = new FileReader();

  reader.onload = () => {
    var image = new Image();
    image.onload = () => {
      Promise.all([
        createImageBitmap(image, 0, 0, image.width, image.height, {resizeQuality: 'high'})
      ]).then(imgBitmap => {
        mapCtx.clearRect(0, 0, mapCanvas.width, mapCanvas.height);
        overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
        drawBackground(imgBitmap[0]);
        document.getElementById('name').innerText = 'Map';
        overlayCtx.beginPath();
        if (isAdmin) {
          overlayCtx.globalAlpha = 0.6;
        } else {
          overlayCtx.globalAlpha = 1;
        }
        overlayCtx.fillStyle = "#111111";
        overlayCtx.fillRect(0, 0, overlayCanvas.width, overlayCanvas.height);
      });
    }
    image.src = reader.result;
  }
  reader.readAsDataURL(file);
}, false);

overlayCtx.fillCircle = function(x, y, radius, fillColor) {
  this.fillStyle = fillColor;
  this.beginPath();
  this.moveTo(x, y);
  this.arc(x, y, radius, 0, Math.PI * 2, false);
  this.fill();
};
// https://jsfiddle.net/ArtBIT/WUXDb/1/, thanks kind stranger (actually heavily modified, I don't mind taking credit for this now kek)
overlayCanvas.onmousemove = function(e) {
  if (!overlayCanvas.isDrawing) {
    return;
  }
  var container = document.getElementById('canvas-container');
  var scaleX = overlayCanvas.width / container.clientWidth,
    scaleY = overlayCanvas.height / container.clientHeight;
  var x = (e.clientX - container.offsetLeft) * scaleX,
    y = (e.clientY - container.offsetTop) * scaleY;
  overlayCtx.clearRect(x - 3, y - 3, 7, 7);
};
overlayCanvas.onmousedown = function(e) {
  overlayCanvas.isDrawing = true;
};
overlayCanvas.onmouseup = function(e) {
  overlayCanvas.isDrawing = false;
};

</script>
</body>
</html>
